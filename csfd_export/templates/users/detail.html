<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ČSFD Export of user {{ uid }}</title>
    {% load static %}
    <link
      rel="stylesheet"
      href="{% static 'csfd_export/main.css' %}"
      type="text/css"
      media="screen"
    />
    <style>
      .js .noscript {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <main>
        <div class="container">
          <div id="done">
            <h2 class="border-success">Here is your ČSFD ratings export</h2>
            <p>
              Please note that if you add or change a rating on ČSFD now, it can
              take up to 1h before it appears in the next export.
            </p>
            <p>
              <a
                href="data:text/plain;charset=utf-8,{{ csv|iriencode }}"
                download="csfd_export_{{ uid }}.csv"
                class="button background-success border-success"
                >Download as CSV</a
              >
              <button
                onclick="navigator.clipboard.writeText(document.getElementById('csv').textContent).then()"
                class="button background-success border-success"
              >
                Copy to clipboard
              </button>
              <a href="{% url 'index' %}" class="button">Go back</a>
            </p>
            <pre id="csv" class="box background-muted flex-grow mr-1-desktop">
{{ csv }}</pre
            >
          </div>
          {% if not csv %}
          <div id="loading">
            <h2>Exporting your ČSFD ratings...</h2>
            <p>The spreadsheet will be ready in a minute.</p>
            <a href="{% url 'user-detail' uid %}" class="noscript">Refresh</a>
            <script>
              document.getElementById('done').classList.add('hidden');
              fetch('/api/users/{{ uid }}')
                .then(res => {
                  if (!res.ok) {
                    // TODO Retry
                    return;
                  }
                  res
                    .text()
                    .then(csv => {
                      document.getElementById('csv').textContent = csv;
                      document
                        .getElementById('done')
                        .classList.remove('hidden');
                    })
                    .catch(console.error);
                })
                .catch(console.error);
            </script>
          </div>
          {% endif %}
        </div>
      </main>
      <footer>
        <a href="https://www.jakubvalenta.cz/" target="_blank" rel="noreferrer"
          >Jakub Valenta</a
        >
        2024
        <a
          href="https://github.com/jakubvalenta/csfd-export"
          target="_blank"
          rel="noreferrer"
          >code</a
        >
      </footer>
    </div>
    <script>
      document.body.classList.add('js');
    </script>
  </body>
</html>
